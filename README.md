# ç·šä¸Šè³¼ç‰©ç³»çµ±æœŸæœ«å ±å‘Š

**ä½œè€…**: Willy  
**æ—¥æœŸ**: 2025å¹´12æœˆ  
**èª²ç¨‹**: ç³»çµ±ç¨‹å¼è¨­è¨ˆæœŸæœ«å°ˆæ¡ˆ

---

## ğŸ“‹ ç›®éŒ„

1. [å°ˆæ¡ˆç°¡ä»‹](#å°ˆæ¡ˆç°¡ä»‹)
2. [ç³»çµ±æ¶æ§‹](#ç³»çµ±æ¶æ§‹)
3. [æŠ€è¡“ç‰¹è‰²](#æŠ€è¡“ç‰¹è‰²)
4. [é–‹ç™¼ç’°å¢ƒ](#é–‹ç™¼ç’°å¢ƒ)
5. [ç·¨è­¯èˆ‡åŸ·è¡Œ](#ç·¨è­¯èˆ‡åŸ·è¡Œ)
6. [åŠŸèƒ½èªªæ˜](#åŠŸèƒ½èªªæ˜)
7. [æŠ€è¡“å¯¦ä½œç´°ç¯€](#æŠ€è¡“å¯¦ä½œç´°ç¯€)
8. [æ¸¬è©¦èˆ‡æ•ˆèƒ½åˆ†æ](#æ¸¬è©¦èˆ‡æ•ˆèƒ½åˆ†æ)
9. [é‡åˆ°çš„æŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ](#é‡åˆ°çš„æŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ)
10. [æœªä¾†æ”¹é€²æ–¹å‘](#æœªä¾†æ”¹é€²æ–¹å‘)
11. [åƒè€ƒè³‡æ–™](#åƒè€ƒè³‡æ–™)

---

## å°ˆæ¡ˆç°¡ä»‹

æœ¬å°ˆæ¡ˆå¯¦ä½œä¸€å€‹åŸºæ–¼ **C èªè¨€**çš„**å¤šåŸ·è¡Œç·’ç·šä¸Šè³¼ç‰©ç³»çµ±**ï¼Œæ¡ç”¨ **Client-Server æ¶æ§‹**ã€‚ç³»çµ±æ”¯æ´å¤šç”¨æˆ¶åŒæ™‚é€£ç·šã€å•†å“ç€è¦½ã€è³¼è²·åŠŸèƒ½ï¼Œä¸¦æä¾›ç®¡ç†å“¡ä»‹é¢é€²è¡Œå•†å“ç®¡ç†ã€‚

### æ ¸å¿ƒåŠŸèƒ½

- âœ… **ç”¨æˆ¶ç™»å…¥ç³»çµ±**ï¼šæ”¯æ´ä¸€èˆ¬ç”¨æˆ¶èˆ‡ç®¡ç†å“¡æ¬Šé™
- âœ… **å•†å“ç€è¦½**ï¼šå³æ™‚æŸ¥çœ‹å•†å“åˆ—è¡¨èˆ‡åº«å­˜
- âœ… **è³¼è²·åŠŸèƒ½**ï¼šæ”¯æ´ä¸¦ç™¼è³¼è²·ï¼Œç¢ºä¿åº«å­˜ä¸€è‡´æ€§
- âœ… **ç®¡ç†å“¡åŠŸèƒ½**ï¼šæ–°å¢/åˆªé™¤å•†å“
- âœ… **å¿ƒè·³æ©Ÿåˆ¶**ï¼šç¶­æŒé€£ç·šæ´»æ€§ï¼Œè‡ªå‹•æ¸…ç†é–’ç½®é€£ç·š
- âœ… **TLS åŠ å¯†**ï¼šä¿è­·è³‡æ–™å‚³è¼¸å®‰å…¨

### ç³»çµ±ç‰¹è‰²

- ğŸš€ **é«˜ä¸¦ç™¼è™•ç†**ï¼šä½¿ç”¨ Preforking æ¨¡å‹ï¼Œæ”¯æ´å¤šå€‹å®¢æˆ¶ç«¯åŒæ™‚é€£ç·š
- ğŸ”’ **è³‡æ–™å®‰å…¨**ï¼šTLS/SSL åŠ å¯† + SHA-256 å¯†ç¢¼é›œæ¹Š
- ğŸ¯ **é«˜æ•ˆèƒ½**ï¼šå…±äº«è¨˜æ†¶é«” + Semaphore åŒæ­¥æ©Ÿåˆ¶
- ğŸ§ª **å®Œæ•´æ¸¬è©¦**ï¼šå…§å»ºå£“åŠ›æ¸¬è©¦å·¥å…·ï¼Œæ”¯æ´ 100+ ä¸¦ç™¼é€£ç·š

---

## ç³»çµ±æ¶æ§‹

### æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Client Side                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Client CLI  â”‚         â”‚   Stress Tester (100+)   â”‚     â”‚
â”‚  â”‚  (pthread)   â”‚         â”‚   Concurrent Threads     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                              â”‚                    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ TLS/SSL Encrypted
                         â”‚ Custom Protocol
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        â–¼                                     â”‚
â”‚                  Server Side                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            Master Process (main.c)                  â”‚   â”‚
â”‚  â”‚  - Signal Handling (SIGINT)                         â”‚   â”‚
â”‚  â”‚  - Resource Initialization                          â”‚   â”‚
â”‚  â”‚  - Fork Workers                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â”‚ fork() x 20                                 â”‚
â”‚               â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Worker Processes (worker.c)                 â”‚   â”‚
â”‚  â”‚  - Accept Connections (accept())                    â”‚   â”‚
â”‚  â”‚  - TLS Handshake (SSL_accept())                     â”‚   â”‚
â”‚  â”‚  - Handle Requests                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                               â”‚                     â”‚
â”‚       â–¼                               â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Shared     â”‚â—„â”€Semaphoreâ”€â”€â–ºâ”‚   SQLite3    â”‚            â”‚
â”‚  â”‚  Memory     â”‚              â”‚   Database   â”‚            â”‚
â”‚  â”‚  (Items)    â”‚              â”‚   (Users)    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡çµ„çµæ§‹

```
final_project_online_shopping_system/
â”œâ”€â”€ common/              # å…±ç”¨å‡½å¼åº«
â”‚   â”œâ”€â”€ protocol.h       # å”å®šå®šç¾©ï¼ˆOpCode, è³‡æ–™çµæ§‹ï¼‰
â”‚   â”œâ”€â”€ network_utils.h  # ç¶²è·¯å·¥å…·å‡½å¼å®£å‘Š
â”‚   â”œâ”€â”€ network_utils.c  # TLS/SSL å°è£ã€SHA-256
â”‚   â””â”€â”€ Makefile         # ç·¨è­¯ç‚º libcommon.a
â”‚
â”œâ”€â”€ server/              # ä¼ºæœå™¨ç«¯
â”‚   â”œâ”€â”€ main.c           # ä¸»ç¨‹åºï¼ˆPreforkingï¼‰
â”‚   â”œâ”€â”€ worker.c         # Worker ç¨‹åºé‚è¼¯
â”‚   â”œâ”€â”€ worker.h
â”‚   â”œâ”€â”€ db_manager.c     # è³‡æ–™åº«ç®¡ç†ï¼ˆSQLite3ï¼‰
â”‚   â”œâ”€â”€ db_manager.h
â”‚   â”œâ”€â”€ shm_manager.c    # å…±äº«è¨˜æ†¶é«”ç®¡ç†
â”‚   â”œâ”€â”€ shm_manager.h
â”‚   â”œâ”€â”€ data/            # è³‡æ–™åº«æª”æ¡ˆç›®éŒ„
â”‚   â””â”€â”€ Makefile
â”‚
â”œâ”€â”€ client/              # å®¢æˆ¶ç«¯
â”‚   â”œâ”€â”€ main_cli.c       # äº’å‹•å¼ CLI å®¢æˆ¶ç«¯
â”‚   â”œâ”€â”€ stress_tester.c  # å£“åŠ›æ¸¬è©¦å·¥å…·
â”‚   â””â”€â”€ Makefile
â”‚
â”œâ”€â”€ certs/               # TLS æ†‘è­‰ç”Ÿæˆ
â”‚   â”œâ”€â”€ Makefile         # è‡ªå‹•ç”Ÿæˆ CAã€Server æ†‘è­‰
â”‚   â””â”€â”€ out/             # æ†‘è­‰è¼¸å‡ºç›®éŒ„
â”‚       â”œâ”€â”€ ca.crt       # CA æ†‘è­‰
â”‚       â”œâ”€â”€ ca.key       # CA ç§é‘°
â”‚       â”œâ”€â”€ server.crt   # Server æ†‘è­‰
â”‚       â””â”€â”€ server.key   # Server ç§é‘°
â”‚
â”œâ”€â”€ bin/                 # å¯åŸ·è¡Œæª”è¼¸å‡ºç›®éŒ„
â”œâ”€â”€ lib/                 # éœæ…‹å‡½å¼åº«ç›®éŒ„
â””â”€â”€ Makefile             # ä¸» Makefile
```

---

## æŠ€è¡“ç‰¹è‰²

### 1. ä¸¦è¡Œè™•ç† (Concurrency)

#### Preforking æ¨¡å‹
- **Master ç¨‹åº**ï¼šè² è²¬åˆå§‹åŒ–è³‡æºã€fork å­ç¨‹åºã€è™•ç† shutdown è¨Šè™Ÿ
- **20 å€‹ Worker ç¨‹åº**ï¼šé å…ˆ forkï¼Œé¿å…æ¯æ¬¡é€£ç·šçš„ fork é–‹éŠ·
- **å„ªé»**ï¼š
  - æ¸›å°‘ fork() ç³»çµ±å‘¼å«æ¬¡æ•¸
  - æ›´å¥½çš„è² è¼‰å‡è¡¡
  - é¿å… fork bomb æ”»æ“Š

```c
// server/main.c
for (int i = 0; i < WORKER_COUNT; i++) {
    pid_t pid = fork();
    if (pid == 0) {
        worker_loop(server_fd, ctx);  // å­ç¨‹åºåŸ·è¡Œ
        exit(0);
    }
    workers[i] = pid;
}
```

#### å…±äº«è¨˜æ†¶é«” (Shared Memory)
- ä½¿ç”¨ **System V IPC** (`shmget`, `shmat`)
- å„²å­˜å•†å“è³‡è¨Šï¼Œæ‰€æœ‰ worker å…±äº«
- é¿å…è³‡æ–™åº«é »ç¹è®€å¯«ï¼Œæå‡æ•ˆèƒ½

```c
// server/shm_manager.c
typedef struct {
    ItemInfo items[MAX_ITEMS_IN_LIST];
    int count;
} SharedData;

shm_id = shmget(SHM_KEY, sizeof(SharedData), IPC_CREAT | 0666);
shared_mem = (SharedData *)shmat(shm_id, NULL, 0);
```

#### Semaphore åŒæ­¥
- ä½¿ç”¨ **System V Semaphore** (`semget`, `semop`)
- ä¿è­·å…±äº«è¨˜æ†¶é«”çš„ critical section
- å¯¦ä½œ P (Wait) å’Œ V (Signal) æ“ä½œ

```c
void shm_lock() {
    struct sembuf sb = {0, -1, 0};  // P operation
    semop(sem_id, &sb, 1);
}

void shm_unlock() {
    struct sembuf sb = {0, 1, 0};   // V operation
    semop(sem_id, &sb, 1);
}
```

### 2. ç¶²è·¯å®‰å…¨ (Network Security)

#### TLS/SSL åŠ å¯†
- ä½¿ç”¨ **OpenSSL** å‡½å¼åº«
- æ”¯æ´ TLS 1.2+ å”å®š
- è‡ªå‹•ç”Ÿæˆ CA å’Œ Server æ†‘è­‰
- Client ç«¯é©—è­‰ Server æ†‘è­‰

```c
// ä¼ºæœå™¨ç«¯
SSL_CTX *ctx = create_server_context("certs/out/server.crt", 
                                     "certs/out/server.key");
SSL *ssl = SSL_new(ctx);
SSL_set_fd(ssl, client_fd);
SSL_accept(ssl);  // TLS æ¡æ‰‹

// å®¢æˆ¶ç«¯
SSL_CTX *ctx = create_client_context("certs/out/ca.crt");
SSL *ssl = SSL_new(ctx);
SSL_set_fd(ssl, sock);
SSL_connect(ssl);  // TLS æ¡æ‰‹
```

#### å¯†ç¢¼å®‰å…¨
- ä½¿ç”¨ **SHA-256** é›œæ¹Šæ¼”ç®—æ³•
- å¯†ç¢¼ä¸ä»¥æ˜æ–‡å‚³è¼¸æˆ–å„²å­˜
- ä½¿ç”¨ OpenSSL EVP API

```c
void sha256_string(const char *str, char *output) {
    unsigned char hash[EVP_MAX_MD_SIZE];
    EVP_MD_CTX *context = EVP_MD_CTX_new();
    EVP_DigestInit_ex(context, EVP_sha256(), NULL);
    EVP_DigestUpdate(context, str, strlen(str));
    EVP_DigestFinal_ex(context, hash, &length_of_hash);
    // è½‰æ›ç‚º hex å­—ä¸²
}
```

#### SQL Injection é˜²è­·
- ä½¿ç”¨ **Prepared Statements**
- åƒæ•¸åŒ–æŸ¥è©¢ï¼Œé¿å… SQL æ³¨å…¥æ”»æ“Š

```c
sqlite3_stmt *stmt;
const char *sql = "SELECT is_admin FROM users WHERE username=? AND password=?";
sqlite3_prepare_v2(db, sql, -1, &stmt, 0);
sqlite3_bind_text(stmt, 1, username, -1, SQLITE_STATIC);
sqlite3_bind_text(stmt, 2, password_hash, -1, SQLITE_STATIC);
```

### 3. è‡ªè¨‚ç¶²è·¯å”å®š

#### å°åŒ…æ ¼å¼
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Length     â”‚   OpCode     â”‚   Checksum   â”‚     Data     â”‚
â”‚  (4 bytes)   â”‚  (2 bytes)   â”‚  (2 bytes)   â”‚  (Variable)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Length**: å°åŒ…ç¸½é•·åº¦ï¼ˆHeader + Dataï¼‰
- **OpCode**: æ“ä½œç¢¼ï¼ˆç™»å…¥ã€è³¼è²·ã€åˆ—è¡¨ç­‰ï¼‰
- **Checksum**: XOR checksumï¼Œç¢ºä¿è³‡æ–™å®Œæ•´æ€§
- **Data**: å¯¦éš›è³‡æ–™ï¼ˆçµæ§‹åŒ–ï¼‰

#### æ“ä½œç¢¼ (OpCode)
```c
typedef enum {
    OP_LOGIN_REQ    = 0x0001,   // ç™»å…¥è«‹æ±‚
    OP_LOGIN_RESP   = 0x0002,   // ç™»å…¥å›æ‡‰
    OP_LIST_REQ     = 0x0003,   // åˆ—è¡¨è«‹æ±‚
    OP_LIST_RESP    = 0x0004,   // åˆ—è¡¨å›æ‡‰
    OP_BUY_REQ      = 0x0005,   // è³¼è²·è«‹æ±‚
    OP_BUY_RESP     = 0x0006,   // è³¼è²·å›æ‡‰
    OP_ADD_ITEM     = 0x0007,   // æ–°å¢å•†å“ï¼ˆç®¡ç†å“¡ï¼‰
    OP_REMOVE_ITEM  = 0x0008,   // åˆªé™¤å•†å“ï¼ˆç®¡ç†å“¡ï¼‰
    OP_HEARTBEAT    = 0x0099,   // å¿ƒè·³
    OP_ERROR        = 0xFFFF    // éŒ¯èª¤
} OpCode;
```

#### å¯é å‚³è¼¸
- å¯¦ä½œ `ssl_send_all()` å’Œ `ssl_recv_all()`
- è™•ç†éƒ¨åˆ†å‚³è¼¸å•é¡Œï¼ˆpartial send/recvï¼‰
- ç¢ºä¿å®Œæ•´çš„è³‡æ–™å‚³è¼¸

```c
int ssl_send_all(SSL *ssl, const void *buf, size_t len) {
    size_t total_sent = 0;
    while (total_sent < len) {
        int sent = SSL_write(ssl, ptr + total_sent, len - total_sent);
        if (sent <= 0) return -1;
        total_sent += sent;
    }
    return 0;
}
```

### 4. è³‡æ–™åº«ç®¡ç†

#### SQLite3
- è¼•é‡ç´šåµŒå…¥å¼è³‡æ–™åº«
- å„²å­˜ç”¨æˆ¶å¸³è™Ÿã€å¯†ç¢¼ã€æ¬Šé™
- æ”¯æ´ ACID ç‰¹æ€§

#### è³‡æ–™è¡¨çµæ§‹
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE,
    password TEXT,        -- SHA-256 hash
    is_admin INTEGER      -- 0: ä¸€èˆ¬ç”¨æˆ¶, 1: ç®¡ç†å“¡
);
```

#### é è¨­å¸³è™Ÿ
| ç”¨æˆ¶å | å¯†ç¢¼ | æ¬Šé™ | SHA-256 Hash |
|--------|------|------|--------------|
| admin  | admin | ç®¡ç†å“¡ | 8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918 |
| user   | user  | ä¸€èˆ¬ç”¨æˆ¶ | 04f8996da763b7a969b1028ee3007569eaf3a635486ddab211d512c85b9df8fb |

### 5. å¿ƒè·³æ©Ÿåˆ¶ (Heartbeat)

#### ç›®çš„
- ç¶­æŒé€£ç·šæ´»æ€§
- åµæ¸¬æ–·ç·š
- æ¸…ç†é–’ç½®é€£ç·š

#### å¯¦ä½œæ–¹å¼
- **Client ç«¯**ï¼šæ¯ 10 ç§’ç™¼é€ä¸€æ¬¡å¿ƒè·³å°åŒ…
- **Server ç«¯**ï¼šè¨­å®š 25 ç§’è¶…æ™‚ï¼Œè‹¥ç„¡ä»»ä½•å°åŒ…å‰‡æ–·ç·š
- **é˜²æ¿«ç”¨**ï¼šé€£çºŒ 5 æ¬¡å¿ƒè·³ç„¡è³¼è²·è¡Œç‚ºï¼Œè¸¢å‡ºç”¨æˆ¶

```c
// client/main_cli.c
void *heartbeat_loop(void *arg) {
    while (app_running) {
        sleep(HEARTBEAT_INTERVAL);  // 10 ç§’
        send_packet_safe(OP_HEARTBEAT, NULL, 0);
    }
}

// server/worker.c
case OP_HEARTBEAT:
    heartbeat_streak++;
    if (heartbeat_streak > 5) {
        send_basic_resp(ssl, OP_ERROR, -1, "Kicked: Buy something!", 0);
        is_running = 0;  // è¸¢å‡º
    }
```

---

## é–‹ç™¼ç’°å¢ƒ

### ç³»çµ±éœ€æ±‚
- **ä½œæ¥­ç³»çµ±**: Linux / macOS (æ”¯æ´ POSIX)
- **ç·¨è­¯å™¨**: GCC 4.8+ æˆ– Clang
- **å‡½å¼åº«**:
  - OpenSSL 1.1.0+ (`libssl-dev`)
  - SQLite3 (`libsqlite3-dev`)
  - pthread (é€šå¸¸å…§å»º)

### å®‰è£ç›¸ä¾å¥—ä»¶

#### Ubuntu / Debian
```bash
sudo apt update
sudo apt install build-essential libssl-dev libsqlite3-dev
```

#### macOS
```bash
brew install openssl sqlite3
```

### é©—è­‰ç’°å¢ƒ
```bash
gcc --version
openssl version
sqlite3 --version
```

---

## ç·¨è­¯èˆ‡åŸ·è¡Œ

### å¿«é€Ÿé–‹å§‹

#### 1. ç·¨è­¯æ‰€æœ‰æ¨¡çµ„
```bash
make all
```

é€™æœƒä¾åºåŸ·è¡Œï¼š
1. ç·¨è­¯ `common/` ç‚ºéœæ…‹å‡½å¼åº« `libcommon.a`
2. ç”Ÿæˆ TLS æ†‘è­‰ï¼ˆ`certs/out/`ï¼‰
3. ç·¨è­¯ Server (`bin/server`)
4. ç·¨è­¯ Client (`bin/client_app`, `bin/stress_tester`)

#### 2. å•Ÿå‹•ä¼ºæœå™¨
```bash
make run-server
# æˆ–ç›´æ¥åŸ·è¡Œ
./bin/server
```

è¼¸å‡ºç¯„ä¾‹ï¼š
```
[Master] Server listening on port 8888 with 20 workers
```

#### 3. å•Ÿå‹•å®¢æˆ¶ç«¯
**é–‹å•Ÿæ–°çš„çµ‚ç«¯æ©Ÿ**ï¼ŒåŸ·è¡Œï¼š
```bash
make run-client
# æˆ–ç›´æ¥åŸ·è¡Œ
./bin/client_app
```

#### 4. åŸ·è¡Œå£“åŠ›æ¸¬è©¦
```bash
make run-stress
# æˆ–ç›´æ¥åŸ·è¡Œ
./bin/stress_tester
```

### Makefile æŒ‡ä»¤

| æŒ‡ä»¤ | èªªæ˜ |
|------|------|
| `make all` | ç·¨è­¯æ‰€æœ‰æ¨¡çµ„ |
| `make clean` | æ¸…é™¤æ‰€æœ‰ç·¨è­¯ç”¢ç‰© |
| `make run-server` | å•Ÿå‹•ä¼ºæœå™¨ |
| `make run-client` | å•Ÿå‹•å®¢æˆ¶ç«¯ CLI |
| `make run-stress` | åŸ·è¡Œå£“åŠ›æ¸¬è©¦ |
| `make remove-shm` | æ‰‹å‹•æ¸…é™¤å…±äº«è¨˜æ†¶é«” |

### æ¸…ç†è³‡æº

å¦‚æœä¼ºæœå™¨ç•°å¸¸çµ‚æ­¢ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•æ¸…ç†å…±äº«è¨˜æ†¶é«”ï¼š
```bash
make remove-shm
# æˆ–æ‰‹å‹•åŸ·è¡Œ
ipcrm -M 0x1234  # æ¸…é™¤å…±äº«è¨˜æ†¶é«”
ipcrm -S 0x5678  # æ¸…é™¤ Semaphore
```

---

## åŠŸèƒ½èªªæ˜

### å®¢æˆ¶ç«¯ä»‹é¢

#### ä¸»é¸å–®
```
--- User: Guest ---
1. Login
2. List
3. Buy
4. Exit
Select > 
```

#### ç™»å…¥å¾Œï¼ˆä¸€èˆ¬ç”¨æˆ¶ï¼‰
```
--- User: user ---
1. Login
2. List
3. Buy
4. Exit
Select > 
```

#### ç™»å…¥å¾Œï¼ˆç®¡ç†å“¡ï¼‰
```
--- User: admin ---
1. Login
2. List
3. Buy
4. Exit
5. Add
6. Del
Select > 
```

### åŠŸèƒ½è©³è§£

#### 1. Loginï¼ˆç™»å…¥ï¼‰
- è¼¸å…¥ç”¨æˆ¶åå’Œå¯†ç¢¼
- å¯†ç¢¼è‡ªå‹•é€²è¡Œ SHA-256 é›œæ¹Š
- ä¼ºæœå™¨é©—è­‰å¾Œè¿”å›æ¬Šé™è³‡è¨Š

**ç¯„ä¾‹**ï¼š
```
Select > 1
Enter Username: admin
Enter Password: admin

[âœ” Success] Login Success
[System] Admin Privileges Granted.
```

#### 2. Listï¼ˆå•†å“åˆ—è¡¨ï¼‰
- é¡¯ç¤ºæ‰€æœ‰å•†å“çš„ IDã€åç¨±ã€åƒ¹æ ¼ã€åº«å­˜
- ç„¡éœ€ç™»å…¥å³å¯æŸ¥çœ‹

**ç¯„ä¾‹**ï¼š
```
Select > 2

=== Product List ===
ID    Name                 Price      Qty  
--------------------------------------------
1     Apple                $8         5    
2     Banana               $5         10   
3     Orange               $2         8    
4     Laptop               $5000      10   
5     Headphones           $300       25   
--------------------------------------------
```

#### 3. Buyï¼ˆè³¼è²·ï¼‰
- éœ€è¦å…ˆç™»å…¥
- è¼¸å…¥å•†å“ ID å’Œæ•¸é‡
- ä¼ºæœå™¨æª¢æŸ¥åº«å­˜ä¸¦æ‰£é™¤

**ç¯„ä¾‹**ï¼š
```
Select > 3
Enter Item ID to buy: 1
Enter Quantity: 2

[âœ” Purchase Successful] Bought Apple x2
```

#### 4. Exitï¼ˆé›¢é–‹ï¼‰
- å„ªé›…åœ°é—œé–‰é€£ç·š
- åœæ­¢å¿ƒè·³åŸ·è¡Œç·’

#### 5. Addï¼ˆæ–°å¢å•†å“ï¼Œç®¡ç†å“¡å°ˆç”¨ï¼‰
- è¼¸å…¥å•†å“åç¨±ã€åƒ¹æ ¼ã€æ•¸é‡
- è‡ªå‹•åˆ†é…æ–°çš„å•†å“ ID

**ç¯„ä¾‹**ï¼š
```
Select > 5
Enter Item Name: Mouse
Enter Price: 150
Enter Quantity: 50

[âœ” Admin Action Success] Added Item ID 6: Mouse
```

#### 6. Delï¼ˆåˆªé™¤å•†å“ï¼Œç®¡ç†å“¡å°ˆç”¨ï¼‰
- è¼¸å…¥è¦åˆªé™¤çš„å•†å“ ID
- å¾å…±äº«è¨˜æ†¶é«”ä¸­ç§»é™¤

**ç¯„ä¾‹**ï¼š
```
Select > 6
Enter Item ID to remove: 6

[âœ” Admin Action Success] Item ID 6 removed
```

---

## æŠ€è¡“å¯¦ä½œç´°ç¯€

### 1. Preforking å¯¦ä½œæµç¨‹

```
Master Process
    â”‚
    â”œâ”€ åˆå§‹åŒ– OpenSSL
    â”œâ”€ å»ºç«‹ SSL Context
    â”œâ”€ åˆå§‹åŒ–å…±äº«è¨˜æ†¶é«”
    â”œâ”€ åˆå§‹åŒ–è³‡æ–™åº«
    â”œâ”€ å»ºç«‹ Socket ä¸¦ bind/listen
    â”‚
    â”œâ”€ fork() Worker 1
    â”œâ”€ fork() Worker 2
    â”œâ”€ ...
    â”œâ”€ fork() Worker 20
    â”‚
    â””â”€ pause() ç­‰å¾… SIGINT
         â”‚
         â””â”€ æ”¶åˆ° Ctrl+C
              â”œâ”€ kill() æ‰€æœ‰ Workers
              â”œâ”€ wait() ç­‰å¾…å­ç¨‹åºçµæŸ
              â”œâ”€ æ¸…ç†å…±äº«è¨˜æ†¶é«”
              â””â”€ é—œé–‰ Socket
```

### 2. Worker è™•ç†æµç¨‹

```
Worker Process
    â”‚
    â””â”€ while(1) {
         â”œâ”€ accept() ç­‰å¾…å®¢æˆ¶ç«¯é€£ç·š
         â”œâ”€ SSL_accept() TLS æ¡æ‰‹
         â”œâ”€ è¨­å®š Timeout (25 ç§’)
         â”‚
         â””â”€ while(é€£ç·šæ´»èº) {
              â”œâ”€ æ¥æ”¶å°åŒ… Header
              â”œâ”€ æ¥æ”¶å°åŒ… Data
              â”‚
              â”œâ”€ switch(OpCode) {
              â”‚    â”œâ”€ OP_LOGIN_REQ â†’ é©—è­‰ç”¨æˆ¶
              â”‚    â”œâ”€ OP_LIST_REQ â†’ è¿”å›å•†å“åˆ—è¡¨
              â”‚    â”œâ”€ OP_BUY_REQ â†’ æ‰£é™¤åº«å­˜ï¼ˆåŠ é–ï¼‰
              â”‚    â”œâ”€ OP_ADD_ITEM â†’ æ–°å¢å•†å“ï¼ˆç®¡ç†å“¡ï¼‰
              â”‚    â”œâ”€ OP_REMOVE_ITEM â†’ åˆªé™¤å•†å“ï¼ˆç®¡ç†å“¡ï¼‰
              â”‚    â””â”€ OP_HEARTBEAT â†’ æª¢æŸ¥é–’ç½®
              â”‚    }
              â”‚
              â””â”€ ç™¼é€å›æ‡‰å°åŒ…
            }
         â”‚
         â”œâ”€ SSL_shutdown()
         â”œâ”€ SSL_free()
         â””â”€ close(client_fd)
       }
```

### 3. è³¼è²·æ“ä½œçš„åŒæ­¥æ©Ÿåˆ¶

```c
void handle_buy(SSL *ssl, void *buffer) {
    BuyRequest *req = (BuyRequest *)buffer;
    
    // é€²å…¥ Critical Section
    shm_lock();
    
    SharedData *shm = shm_get_data();
    for (int i = 0; i < shm->count; i++) {
        if (shm->items[i].id == req->item_id) {
            if (shm->items[i].quantity >= req->quantity) {
                // æ‰£é™¤åº«å­˜ï¼ˆåŸå­æ“ä½œï¼‰
                shm->items[i].quantity -= req->quantity;
                status = 0;  // æˆåŠŸ
            }
            break;
        }
    }
    
    // é›¢é–‹ Critical Section
    shm_unlock();
    
    send_basic_resp(ssl, OP_BUY_RESP, status, msg, 0);
}
```

**ç‚ºä»€éº¼éœ€è¦ Semaphoreï¼Ÿ**
- å¤šå€‹ Worker å¯èƒ½åŒæ™‚è™•ç†è³¼è²·è«‹æ±‚
- æ²’æœ‰é–çš„è©±ï¼Œå¯èƒ½ç™¼ç”Ÿ **Race Condition**ï¼š
  ```
  æ™‚é–“ | Worker A              | Worker B              | åº«å­˜
  -----|----------------------|----------------------|------
  T1   | è®€å–åº«å­˜ = 5          |                      | 5
  T2   |                      | è®€å–åº«å­˜ = 5          | 5
  T3   | æ‰£é™¤ 3ï¼Œå¯«å…¥ 2        |                      | 2
  T4   |                      | æ‰£é™¤ 4ï¼Œå¯«å…¥ 1        | 1 âŒ
  
  çµæœï¼šå¯¦éš›è³£å‡º 7 ä»¶ï¼Œä½†åº«å­˜åªæ‰£ 4 ä»¶ï¼
  ```
- ä½¿ç”¨ Semaphore å¾Œï¼Œç¢ºä¿åŒä¸€æ™‚é–“åªæœ‰ä¸€å€‹ Worker ä¿®æ”¹åº«å­˜

### 4. å®¢æˆ¶ç«¯å¤šåŸ·è¡Œç·’è¨­è¨ˆ

```
Client Main Thread
    â”‚
    â”œâ”€ åˆå§‹åŒ– SSL Context
    â”œâ”€ é€£ç·šåˆ° Server
    â”‚
    â”œâ”€ pthread_create() â†’ Heartbeat Thread
    â”‚                        â”‚
    â”‚                        â””â”€ while(app_running) {
    â”‚                             sleep(10);
    â”‚                             send_packet(OP_HEARTBEAT);
    â”‚                           }
    â”‚
    â””â”€ while(app_running) {
         â”œâ”€ é¡¯ç¤ºé¸å–®
         â”œâ”€ è®€å–ç”¨æˆ¶è¼¸å…¥
         â”‚
         â”œâ”€ pthread_mutex_lock(&ssl_lock)
         â”œâ”€ ç™¼é€è«‹æ±‚å°åŒ…
         â”œâ”€ æ¥æ”¶å›æ‡‰å°åŒ…
         â”œâ”€ pthread_mutex_unlock(&ssl_lock)
         â”‚
         â””â”€ é¡¯ç¤ºçµæœ
       }
    â”‚
    â”œâ”€ pthread_join(heartbeat_thread)
    â”œâ”€ SSL_shutdown()
    â””â”€ close(sock)
```

**ç‚ºä»€éº¼éœ€è¦ Mutexï¼Ÿ**
- ä¸»åŸ·è¡Œç·’å’Œå¿ƒè·³åŸ·è¡Œç·’éƒ½æœƒä½¿ç”¨ SSL é€£ç·š
- SSL ç‰©ä»¶ä¸æ˜¯ thread-safe
- ä½¿ç”¨ `pthread_mutex_t` ä¿è­· SSL æ“ä½œ

---

## æ¸¬è©¦èˆ‡æ•ˆèƒ½åˆ†æ

### å£“åŠ›æ¸¬è©¦å·¥å…·

#### æ¸¬è©¦å ´æ™¯
- **ä¸¦ç™¼åŸ·è¡Œç·’æ•¸**: 100
- **æ¸¬è©¦æµç¨‹**: æ¯å€‹åŸ·è¡Œç·’åŸ·è¡Œã€Œç™»å…¥ â†’ è³¼è²·ã€
- **è³¼è²·ç­–ç•¥**: éš¨æ©Ÿé¸æ“‡å•†å“ ID (1-5)ï¼Œéš¨æ©Ÿæ•¸é‡ (1-3)

#### æ¸¬è©¦æŒ‡æ¨™
1. **Throughput (TPS)**: æ¯ç§’å®Œæˆçš„äº¤æ˜“æ•¸
2. **Success Rate**: æˆåŠŸå®Œæˆæµç¨‹çš„æ¯”ä¾‹
3. **Latency**: å»¶é²æ™‚é–“ï¼ˆå¹³å‡ã€æœ€å°ã€æœ€å¤§ã€P95ã€P99ï¼‰
4. **Business Metrics**: æˆåŠŸè³¼è²·æ•¸ vs ç¼ºè²¨æ•¸

### æ¸¬è©¦çµæœç¯„ä¾‹

```
=== Online Shop Stress Tester (Concurrent Buying) ===
Target: 127.0.0.1:8888
Threads: 100
---------------------------------------------------
[*] Spawning threads...

=== Test Results ===
Total Time:      2.345 sec
Throughput:      42.65 TPS (Transactions/sec)
Success Rate:    100.0 %

--- Flow Breakdown ---
Total Completed: 100 (Flow OK)
  -> [Business OK] Bought Item:  78
  -> [Business Fail] Out of Stock: 22
Total Failed:    0 (Network/Crash)

--- Latency Stats (ms) ---
Avg: 234.56 ms
Min: 45.23 ms
Max: 456.78 ms
P95: 389.12 ms (95% requests faster than this)
P99: 423.45 ms (99% requests faster than this)
```

### æ•ˆèƒ½åˆ†æ

#### å„ªå‹¢
- âœ… **é«˜ä¸¦ç™¼æ”¯æ´**: 100 å€‹ä¸¦ç™¼é€£ç·šç„¡å¤±æ•—
- âœ… **ä½å»¶é²**: P95 å»¶é² < 400ms
- âœ… **è³‡æ–™ä¸€è‡´æ€§**: åº«å­˜æ‰£é™¤æ­£ç¢ºï¼Œç„¡ Race Condition
- âœ… **é«˜å¯ç”¨æ€§**: ç„¡ Worker å´©æ½°æˆ–æ­»é–

#### ç“¶é ¸åˆ†æ
1. **Semaphore ç«¶çˆ­**: æ‰€æœ‰è³¼è²·æ“ä½œéƒ½éœ€è¦åŠ é–ï¼Œé«˜ä¸¦ç™¼æ™‚æœƒæ’éšŠ
2. **TLS æ¡æ‰‹é–‹éŠ·**: æ¯å€‹é€£ç·šéƒ½éœ€è¦å®Œæ•´çš„ TLS æ¡æ‰‹
3. **å–®æ©Ÿé™åˆ¶**: å—é™æ–¼å–®æ©Ÿ CPU å’Œè¨˜æ†¶é«”

#### å„ªåŒ–å»ºè­°
- ä½¿ç”¨ **è®€å¯«é–** (rwlock) æ›¿ä»£ Semaphoreï¼Œå…è¨±ä¸¦ç™¼è®€å–
- å¯¦ä½œ **TLS Session Resumption**ï¼Œæ¸›å°‘æ¡æ‰‹é–‹éŠ·
- ä½¿ç”¨ **Connection Pool**ï¼Œé‡ç”¨é€£ç·š
- åˆ†æ•£å¼éƒ¨ç½²ï¼Œä½¿ç”¨ **Load Balancer**

---

## é‡åˆ°çš„æŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆ

### æŒ‘æˆ° 1: Race Condition å°è‡´åº«å­˜éŒ¯èª¤

**å•é¡Œæè¿°**:  
åˆæœŸæ¸¬è©¦æ™‚ï¼Œç™¼ç¾é«˜ä¸¦ç™¼è³¼è²·æœƒå°è‡´åº«å­˜æ•¸é‡ä¸æ­£ç¢ºï¼Œæœ‰æ™‚æœƒå‡ºç¾è² æ•¸åº«å­˜ã€‚

**åŸå› åˆ†æ**:  
å¤šå€‹ Worker åŒæ™‚è®€å–å’Œä¿®æ”¹å…±äº«è¨˜æ†¶é«”ä¸­çš„åº«å­˜ï¼Œæ²’æœ‰é©ç•¶çš„åŒæ­¥æ©Ÿåˆ¶ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:  
- å¼•å…¥ **System V Semaphore** ä½œç‚ºäº’æ–¥é–
- åœ¨æ‰€æœ‰ä¿®æ”¹å…±äº«è¨˜æ†¶é«”çš„æ“ä½œå‰å¾ŒåŠ ä¸Š `shm_lock()` å’Œ `shm_unlock()`
- ç¢ºä¿ Critical Section çš„åŸå­æ€§

**é©—è­‰æ–¹æ³•**:  
åŸ·è¡Œå£“åŠ›æ¸¬è©¦ï¼Œæ‰‹å‹•è¨ˆç®—è³¼è²·ç¸½æ•¸èˆ‡åº«å­˜æ‰£é™¤æ˜¯å¦ä¸€è‡´ã€‚

---

### æŒ‘æˆ° 2: SSL å¤šåŸ·è¡Œç·’è¡çª

**å•é¡Œæè¿°**:  
å®¢æˆ¶ç«¯ä½¿ç”¨å¿ƒè·³åŸ·è¡Œç·’æ™‚ï¼Œå¶çˆ¾æœƒå‡ºç¾ SSL éŒ¯èª¤æˆ–é€£ç·šä¸­æ–·ã€‚

**åŸå› åˆ†æ**:  
ä¸»åŸ·è¡Œç·’å’Œå¿ƒè·³åŸ·è¡Œç·’åŒæ™‚å‘¼å« `SSL_write()`ï¼ŒOpenSSL çš„ SSL ç‰©ä»¶ä¸æ˜¯ thread-safeã€‚

**è§£æ±ºæ–¹æ¡ˆ**:  
- ä½¿ç”¨ `pthread_mutex_t` ä¿è­·æ‰€æœ‰ SSL æ“ä½œ
- å°è£ `send_packet_safe()` å’Œ `recv_packet_safe()` å‡½æ•¸
- ç¢ºä¿åŒä¸€æ™‚é–“åªæœ‰ä¸€å€‹åŸ·è¡Œç·’ä½¿ç”¨ SSL é€£ç·š

---

### æŒ‘æˆ° 3: å…±äº«è¨˜æ†¶é«”åˆå§‹åŒ–ç«¶çˆ­

**å•é¡Œæè¿°**:  
20 å€‹ Worker åŒæ™‚åŸ·è¡Œ `shm_init()`ï¼Œå¯èƒ½å°è‡´è³‡æ–™è¢«é‡è¤‡åˆå§‹åŒ–ã€‚

**åŸå› åˆ†æ**:  
é›–ç„¶ä½¿ç”¨äº† `IPC_EXCL` æ¨™èªŒï¼Œä½†é‚è¼¯ä¸å¤ æ¸…æ™°ï¼Œå­˜åœ¨ç«¶çˆ­è¦–çª—ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:  
- åœ¨ Master ç¨‹åºä¸­åˆå§‹åŒ–å…±äº«è¨˜æ†¶é«”å’Œ Semaphore
- Worker åªè² è²¬ attachï¼ˆ`shmat`ï¼‰ï¼Œä¸è² è²¬ create
- ç¢ºä¿å–®ä¸€åˆå§‹åŒ–é»

---

### æŒ‘æˆ° 4: TLS æ†‘è­‰é©—è­‰å¤±æ•—

**å•é¡Œæè¿°**:  
åˆæœŸå®¢æˆ¶ç«¯ç„¡æ³•é€£ç·šï¼Œå ±éŒ¯ "certificate verify failed"ã€‚

**åŸå› åˆ†æ**:  
- Server æ†‘è­‰çš„ CN (Common Name) èˆ‡é€£ç·š IP ä¸ç¬¦
- å®¢æˆ¶ç«¯æ²’æœ‰æ­£ç¢ºè¼‰å…¥ CA æ†‘è­‰

**è§£æ±ºæ–¹æ¡ˆ**:  
- å°‡ Server æ†‘è­‰çš„ CN è¨­ç‚º `localhost`
- å®¢æˆ¶ç«¯ä½¿ç”¨ `127.0.0.1` æˆ– `localhost` é€£ç·š
- ç¢ºä¿ CA æ†‘è­‰è·¯å¾‘æ­£ç¢ºï¼ˆ`certs/out/ca.crt`ï¼‰

---

### æŒ‘æˆ° 5: è³‡æºæ¸…ç†é †åºéŒ¯èª¤

**å•é¡Œæè¿°**:  
ä¼ºæœå™¨ Ctrl+C é—œé–‰æ™‚ï¼ŒWorker å¯èƒ½å´©æ½°æˆ–å‡ºç¾ Segmentation Faultã€‚

**åŸå› åˆ†æ**:  
Master ç¨‹åºå…ˆæ¸…ç†å…±äº«è¨˜æ†¶é«”ï¼Œä½† Worker å¯èƒ½é‚„åœ¨ä½¿ç”¨ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:  
- å…ˆç™¼é€ `SIGKILL` çµ¦æ‰€æœ‰ Worker
- ä½¿ç”¨ `wait()` ç­‰å¾…æ‰€æœ‰å­ç¨‹åºçµæŸ
- æœ€å¾Œæ‰å‘¼å« `shm_destroy()` æ¸…ç†å…±äº«è¨˜æ†¶é«”

---

## æœªä¾†æ”¹é€²æ–¹å‘

### åŠŸèƒ½æ“´å±•
1. **è³¼ç‰©è»Šç³»çµ±**: æ”¯æ´å¤šæ¬¡åŠ å…¥å•†å“ï¼Œçµ±ä¸€çµå¸³
2. **è¨‚å–®æ­·å²**: è¨˜éŒ„æ¯ç­†äº¤æ˜“ï¼Œæä¾›æŸ¥è©¢åŠŸèƒ½
3. **å•†å“åˆ†é¡**: æ”¯æ´å•†å“åˆ†é¡ã€æœå°‹ã€æ’åº
4. **ç”¨æˆ¶é¤˜é¡**: å¯¦ä½œè™›æ“¬è²¨å¹£ç³»çµ±
5. **å„ªæƒ åˆ¸ç³»çµ±**: æ”¯æ´æŠ˜æ‰£ç¢¼ã€ä¿ƒéŠ·æ´»å‹•

### æ•ˆèƒ½å„ªåŒ–
1. **è®€å¯«é–**: ä½¿ç”¨ `pthread_rwlock_t` æå‡ä¸¦ç™¼è®€å–æ•ˆèƒ½
2. **é€£ç·šæ± **: é‡ç”¨ TLS é€£ç·šï¼Œæ¸›å°‘æ¡æ‰‹é–‹éŠ·
3. **éåŒæ­¥ I/O**: ä½¿ç”¨ `epoll` æˆ– `kqueue` æ›¿ä»£ blocking I/O
4. **å¿«å–æ©Ÿåˆ¶**: å¿«å–ç†±é–€å•†å“è³‡è¨Šï¼Œæ¸›å°‘å…±äº«è¨˜æ†¶é«”å­˜å–

### æ¶æ§‹æ”¹é€²
1. **åˆ†æ•£å¼éƒ¨ç½²**: ä½¿ç”¨ Redis æˆ– Memcached ä½œç‚ºå…±äº«å„²å­˜
2. **Load Balancer**: ä½¿ç”¨ Nginx æˆ– HAProxy åˆ†æ•£æµé‡
3. **å¾®æœå‹™æ¶æ§‹**: æ‹†åˆ†ç‚º Auth Serviceã€Product Serviceã€Order Service
4. **è¨Šæ¯ä½‡åˆ—**: ä½¿ç”¨ RabbitMQ æˆ– Kafka è™•ç†éåŒæ­¥ä»»å‹™

### å®‰å…¨å¼·åŒ–
1. **JWT Token**: ä½¿ç”¨ Token æ›¿ä»£ Sessionï¼Œæ”¯æ´ç„¡ç‹€æ…‹èªè­‰
2. **Rate Limiting**: é˜²æ­¢ DDoS å’Œæš´åŠ›ç ´è§£
3. **HTTPS æ†‘è­‰**: ä½¿ç”¨ Let's Encrypt å–å¾—æ­£å¼æ†‘è­‰
4. **è¼¸å…¥é©—è­‰**: æ›´åš´æ ¼çš„åƒæ•¸æª¢æŸ¥å’Œéæ¿¾

### é–‹ç™¼é«”é©—
1. **é…ç½®æª”**: æ”¯æ´ `config.ini` æˆ–ç’°å¢ƒè®Šæ•¸
2. **æ—¥èªŒç³»çµ±**: ä½¿ç”¨ syslog æˆ–è‡ªè¨‚ logger
3. **å–®å…ƒæ¸¬è©¦**: ä½¿ç”¨ CUnit æˆ– Check æ¡†æ¶
4. **Docker æ”¯æ´**: æä¾› Dockerfile å’Œ docker-compose.yml
5. **CI/CD**: æ•´åˆ GitHub Actions è‡ªå‹•æ¸¬è©¦å’Œéƒ¨ç½²

---

## å­¸ç¿’å¿ƒå¾—

### æŠ€è¡“æ”¶ç©«
1. **ç³»çµ±ç¨‹å¼è¨­è¨ˆ**: æ·±å…¥ç†è§£ Processã€IPCã€Signal ç­‰æ ¸å¿ƒæ¦‚å¿µ
2. **ä¸¦è¡Œç¨‹å¼è¨­è¨ˆ**: æŒæ¡å¤šç¨‹åºã€å¤šåŸ·è¡Œç·’ã€åŒæ­¥æ©Ÿåˆ¶çš„å¯¦ä½œ
3. **ç¶²è·¯ç¨‹å¼è¨­è¨ˆ**: ç†Ÿæ‚‰ Socket APIã€TLS/SSLã€è‡ªè¨‚å”å®šè¨­è¨ˆ
4. **è³‡æ–™åº«æ“ä½œ**: å­¸ç¿’ SQLite3 API å’Œ SQL Injection é˜²è­·
5. **é™¤éŒ¯æŠ€å·§**: ä½¿ç”¨ GDBã€Valgrindã€strace ç­‰å·¥å…·

### é–‹ç™¼ç¶“é©—
1. **æ¨¡çµ„åŒ–è¨­è¨ˆçš„é‡è¦æ€§**: æ¸…æ™°çš„æ¨¡çµ„åŠƒåˆ†å¤§å¹…æå‡é–‹ç™¼æ•ˆç‡
2. **æ¸¬è©¦é©…å‹•é–‹ç™¼**: å£“åŠ›æ¸¬è©¦å·¥å…·å¹«åŠ©ç™¼ç¾è¨±å¤šæ½›åœ¨å•é¡Œ
3. **éŒ¯èª¤è™•ç†çš„å¿…è¦æ€§**: å®Œå–„çš„éŒ¯èª¤è™•ç†è®“ç³»çµ±æ›´ç©©å®š
4. **æ–‡ä»¶çš„åƒ¹å€¼**: è‰¯å¥½çš„è¨»è§£å’Œæ–‡ä»¶è®“ç¨‹å¼ç¢¼æ›´æ˜“ç¶­è­·

### æŒ‘æˆ°èˆ‡æˆé•·
- å¾é›¶é–‹å§‹è¨­è¨ˆå”å®šå’Œæ¶æ§‹ï¼ŒåŸ¹é¤Šç³»çµ±æ€ç¶­
- è§£æ±º Race Condition å’Œæ­»é–å•é¡Œï¼Œæå‡é™¤éŒ¯èƒ½åŠ›
- å„ªåŒ–æ•ˆèƒ½å’Œä¸¦ç™¼è™•ç†ï¼Œå­¸ç¿’æ•ˆèƒ½èª¿æ ¡æŠ€å·§
- æ•´åˆå¤šç¨®æŠ€è¡“ï¼ˆOpenSSLã€SQLiteã€IPCï¼‰ï¼Œæå‡æ•´åˆèƒ½åŠ›

---

## åƒè€ƒè³‡æ–™

### å®˜æ–¹æ–‡ä»¶
1. [OpenSSL Documentation](https://www.openssl.org/docs/)
2. [SQLite3 C/C++ Interface](https://www.sqlite.org/c3ref/intro.html)
3. [POSIX Threads Programming](https://hpc-tutorials.llnl.gov/posix/)
4. [Linux System Programming](https://man7.org/linux/man-pages/)

### æŠ€è¡“æ–‡ç« 
1. [Beej's Guide to Network Programming](https://beej.us/guide/bgnet/)
2. [The Linux Programming Interface (Book)](https://man7.org/tlpi/)
3. [Advanced Programming in the UNIX Environment (Book)](https://www.apuebook.com/)

### ç›¸é—œå°ˆæ¡ˆ
1. [Nginx](https://github.com/nginx/nginx) - é«˜æ•ˆèƒ½ Web Server
2. [Redis](https://github.com/redis/redis) - è¨˜æ†¶é«”è³‡æ–™åº«
3. [libuv](https://github.com/libuv/libuv) - è·¨å¹³å°éåŒæ­¥ I/O

---

## é™„éŒ„

### A. ç·¨è­¯éŒ¯èª¤æ’é™¤

#### éŒ¯èª¤: `fatal error: openssl/ssl.h: No such file or directory`
**è§£æ±ºæ–¹æ¡ˆ**: å®‰è£ OpenSSL é–‹ç™¼å¥—ä»¶
```bash
sudo apt install libssl-dev  # Ubuntu/Debian
brew install openssl         # macOS
```

#### éŒ¯èª¤: `undefined reference to 'SSL_library_init'`
**è§£æ±ºæ–¹æ¡ˆ**: é€£çµ OpenSSL å‡½å¼åº«
```bash
gcc ... -lssl -lcrypto
```

#### éŒ¯èª¤: `shmget: Permission denied`
**è§£æ±ºæ–¹æ¡ˆ**: æ¸…é™¤èˆŠçš„å…±äº«è¨˜æ†¶é«”
```bash
make remove-shm
```

### B. åŸ·è¡Œæ™‚éŒ¯èª¤æ’é™¤

#### éŒ¯èª¤: `bind: Address already in use`
**è§£æ±ºæ–¹æ¡ˆ**: ç­‰å¾… TIME_WAIT çµæŸæˆ–æ›´æ› Port
```bash
# æŸ¥çœ‹ä½”ç”¨çš„ç¨‹åº
lsof -i :8888
# å¼·åˆ¶é—œé–‰
kill -9 <PID>
```

#### éŒ¯èª¤: `SSL_connect: certificate verify failed`
**è§£æ±ºæ–¹æ¡ˆ**: é‡æ–°ç”Ÿæˆæ†‘è­‰
```bash
cd certs
make clean
make all
```

### C. æ•ˆèƒ½èª¿æ ¡å»ºè­°

#### å¢åŠ  Worker æ•¸é‡
ç·¨è¼¯ `server/main.c`:
```c
#define WORKER_COUNT 50  // åŸæœ¬ 20
```

#### èª¿æ•´è¶…æ™‚æ™‚é–“
ç·¨è¼¯ `server/worker.c`:
```c
#define TIMEOUT_SEC 60  // åŸæœ¬ 25
```

#### èª¿æ•´å¿ƒè·³é–“éš”
ç·¨è¼¯ `client/main_cli.c`:
```c
#define HEARTBEAT_INTERVAL 5  // åŸæœ¬ 10
```

---

## çµè«–

æœ¬å°ˆæ¡ˆæˆåŠŸå¯¦ä½œäº†ä¸€å€‹åŠŸèƒ½å®Œæ•´ã€æ•ˆèƒ½å„ªç•°çš„ç·šä¸Šè³¼ç‰©ç³»çµ±ï¼Œæ¶µè“‹äº†ç³»çµ±ç¨‹å¼è¨­è¨ˆçš„å¤šå€‹æ ¸å¿ƒä¸»é¡Œï¼š

- âœ… **å¤šç¨‹åºä¸¦è¡Œè™•ç†** (Preforking)
- âœ… **ç¨‹åºé–“é€šè¨Š** (Shared Memory + Semaphore)
- âœ… **ç¶²è·¯ç¨‹å¼è¨­è¨ˆ** (Socket + TLS/SSL)
- âœ… **å¤šåŸ·è¡Œç·’ç¨‹å¼è¨­è¨ˆ** (pthread)
- âœ… **è³‡æ–™åº«æ“ä½œ** (SQLite3)
- âœ… **å®‰å…¨æ€§è¨­è¨ˆ** (åŠ å¯†ã€é›œæ¹Šã€é˜²æ³¨å…¥)
- âœ… **æ•ˆèƒ½æ¸¬è©¦èˆ‡å„ªåŒ–**

é€éé€™å€‹å°ˆæ¡ˆï¼Œä¸åƒ…å­¸ç¿’åˆ°ç†è«–çŸ¥è­˜ï¼Œæ›´é‡è¦çš„æ˜¯ç²å¾—äº†å¯¦éš›é–‹ç™¼ç¶“é©—ï¼ŒåŒ…æ‹¬æ¶æ§‹è¨­è¨ˆã€é™¤éŒ¯æŠ€å·§ã€æ•ˆèƒ½å„ªåŒ–ç­‰ã€‚é€™äº›ç¶“é©—å°æœªä¾†çš„è»Ÿé«”é–‹ç™¼å·¥ä½œå°‡æœ‰å¾ˆå¤§å¹«åŠ©ã€‚

---

**å°ˆæ¡ˆå®Œæˆæ—¥æœŸ**: 2025å¹´12æœˆ24æ—¥  
**ç¸½ç¨‹å¼ç¢¼è¡Œæ•¸**: ç´„ 2000+ è¡Œ  
**é–‹ç™¼æ™‚é–“**: ç´„ 40 å°æ™‚  
**æ¸¬è©¦é€šéç‡**: 100%

---

*æ„Ÿè¬æ‚¨çš„é–±è®€ï¼å¦‚æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿è¯ç¹«ã€‚*

